---
- hosts: all
become: yes
become_method: sudo
tasks:
- name: "Apt Update"
apt:
update_cache: true
upgrade: dist
cache_valid_time: 3600
force_apt_get: true
 tasks:
  - name: Установить curl
    yum:
      name: "{{ package }}"
    vars:
      package:
      - curl
      state: latest
- name: Start service firewalld, if not started
  ansible.builtin.service:
    name: firewalld
    state: started
--
- name: Разрешение 80 8080 1834 порта - firewalld
  hosts: test_servers
  become_method: sudo
  become_user: root

  tasks:
  - name: Разрешим 80 порт
    ansible.posix.firewalld:
      service: http
      permanent: yes
      state: enabled
  - name: Разрешим 8080 TCP порт
    ansible.posix.firewalld:
      port: 8080/tcp
      permanent: yes
      state: enabled\
   - name: Разрешим 8080 UDP порт
    ansible.posix.firewalld:
      port: 8080/udp
      permanent: yes
      state: enabled     
   - name: Разрешим 1834 TCP порт
    ansible.posix.firewalld:
      port: 1834/tcp
      permanent: yes
      state: enabled  
   - name: Разрешим 1834 UDP порт
    ansible.posix.firewalld:
      port: 1834/udp
      permanent: yes
      state: enabled             
  - name: Перезапустим service firewalld на всех узлах
    ansible.builtin.service:
      name: firewalld
      state: restarted
- name: Изменение SSH порта
  hosts: all
  gather_facts: false
  vars:
    custom_ssh_port: 1834
  tasks:
    - name: test default ssh port
      local_action: wait_for port=22 timeout=5 host={{inventory_hostname}}
      register: default_ssh
      ignore_errors: true
    - name: set ansible_ssh_port to default
      set_fact: ansible_ssh_port=22
      when: default_ssh.elapsed < 5
    - name: test ssh on high port
      local_action: wait_for port={{custom_ssh_port}} timeout=5 host={{inventory_hostname}}
      register: high_ssh
      when: default_ssh.elapsed >= 5
      ignore_errors: true
    - name: set ansible_ssh_port high
      set_fact: ansible_ssh_port={{custom_ssh_port}}
      when: default_ssh.elapsed >= 5 and high_ssh.elapsed < 5
- name: Создание пользователя Webdeveloper
     user:
      name: Webdeveloper
      password: fffb1335c465dca9358544b40f61bac57f9d05355714436b354459ef92fb7bbbc7287a1058f4843ba4b60d32e2b85235eb5b20367f7709c80bfcbe55adba139b
      groups: docker, sudo   # Empty by default.
      state: present
      shell: /bin/bash       # Defaults to /bin/bash
      system: no             # Defaults to no
      createhome: yes        # Defaults to yes
      home: /home/fideloper  # Defaults to /home/<username>
- name: Установка публичного ключа для Webdeveloper
  authorized_key:
    user: Webdeveloper
    state: present
    key:  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCovvBkeLIDsvbCyQsMWtPWVgGVKcwAqRONiBJ9JyrVCQbruyMPutatjSlhNp>
- name: Создание пользователя Devopsengineer
     user:
      name: Devopsengineer
      password: 008aa217aa7bb76d1c2d193e61649a13eb71d69adf85e30c704c8d202e95fb5b9893f93074730ffa78cae5a926f78371c39ba7e59ba297ff4d1be7f467c7335f
      groups: docker, sudo   # Empty by default.
      state: present
      shell: /bin/bash       # Defaults to /bin/bash
      system: no             # Defaults to no
      createhome: yes        # Defaults to yes
      home: /home/fideloper  # Defaults to /home/<username>
- name: Установка публичного ключа для Devopsengineer
  authorized_key:
    user: Devopsengineer
    state: present
    key:  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCovvBkeLIDsvbCyQsMWtPWVgGVKcwAqRONiBJ9JyrVCQbruyMPutatjSlhNp>
- name: Создание пользователя Projectmanager
     user:
      name: Projectmanager
      password: 584a2c8a0f03cd7e9fd2c6da610aa94e1d80c7d1f36503b51c7f3f73d41059c5e6d130e85ee810333d2bebf679b6c367e3b3d30484656ae40d0422818bd139c9
      groups: docker, sudo   # Empty by default.
      state: present
      shell: /bin/bash       # Defaults to /bin/bash
      system: no             # Defaults to no
      createhome: yes        # Defaults to yes
      home: /home/fideloper  # Defaults to /home/<username>
- name: Установка публичного ключа для Projectmanager
  authorized_key:
    user: Projectmanager
    state: present
    key:  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCovvBkeLIDsvbCyQsMWtPWVgGVKcwAqRONiBJ9JyrVCQbruyMPutatjSlhNp>









